From b8a4aee67f902a5ed5e91bfd02c378bff8fdd125 Mon Sep 17 00:00:00 2001
From: uti <uti.edun@chainguard.dev>
Date: Thu, 2 Oct 2025 14:31:10 +0100
Subject: [PATCH] Added feature detection in werkzeug fab providers to allow
 detecting hashing algorithms available to different versions of werkzeug

---
 .../auth_manager/security_manager/override.py | 21 ++++++++-----------
 1 file changed, 9 insertions(+), 12 deletions(-)

diff --git a/providers/fab/src/airflow/providers/fab/auth_manager/security_manager/override.py b/providers/fab/src/airflow/providers/fab/auth_manager/security_manager/override.py
index b9cfa969b7..7f61649fb9 100644
--- a/providers/fab/src/airflow/providers/fab/auth_manager/security_manager/override.py
+++ b/providers/fab/src/airflow/providers/fab/auth_manager/security_manager/override.py
@@ -790,18 +790,8 @@ class FabAirflowSecurityManagerOverride(AirflowSecurityManagerV2):
         current_app.config.setdefault("AUTH_ROLES_SYNC_AT_LOGIN", False)
         current_app.config.setdefault("AUTH_API_LOGIN_ALLOW_MULTIPLE_PROVIDERS", False)
 
-        from packaging.version import Version
-        from werkzeug import __version__ as werkzeug_version
-
-        parsed_werkzeug_version = Version(werkzeug_version)
-        if parsed_werkzeug_version < Version("3.0.0"):
-            current_app.config.setdefault("FAB_PASSWORD_HASH_METHOD", "pbkdf2:sha256")
-            current_app.config.setdefault(
-                "AUTH_DB_FAKE_PASSWORD_HASH_CHECK",
-                "pbkdf2:sha256:150000$Z3t6fmj2$22da622d94a1f8118"
-                "c0976a03d2f18f680bfff877c9a965db9eedc51bc0be87c",
-            )
-        else:
+        try:
+            _ = generate_password_hash("test", method="scrypt")
             current_app.config.setdefault("FAB_PASSWORD_HASH_METHOD", "scrypt")
             current_app.config.setdefault(
                 "AUTH_DB_FAKE_PASSWORD_HASH_CHECK",
@@ -809,6 +799,13 @@ class FabAirflowSecurityManagerOverride(AirflowSecurityManagerV2):
                 "8350189ffc4bcc71286edf1b8ad94a442c00f890224bf2b32153d0750c89ee9"
                 "401e62f9dcee5399065e4e5",
             )
+        except (ValueError, TypeError):
+            current_app.config.setdefault("FAB_PASSWORD_HASH_METHOD", "pbkdf2:sha256")
+            current_app.config.setdefault(
+                "AUTH_DB_FAKE_PASSWORD_HASH_CHECK",
+                "pbkdf2:sha256:150000$Z3t6fmj2$22da622d94a1f8118"
+                "c0976a03d2f18f680bfff877c9a965db9eedc51bc0be87c",
+            )
 
         # LDAP Config
         if self.auth_type == AUTH_LDAP:
-- 
2.39.5 (Apple Git-154)

